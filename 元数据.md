# S3 服务器元数据格式规范

## 1. 文件路径与用途

| 项目 | 说明 |
|------|------|
| **主文件路径** | `<data_root>/s3_meta.dat`。`data_root` 由配置指定（如环境变量 `S3_DATA_ROOT`）。 |
| **临时写回文件** | `<data_root>/s3_meta.dat.tmp`。写回时先写入该文件，成功后再 `rename` 覆盖主文件，避免写坏原文件。 |
| **用户数据文件** | `<data_root>/user.dat`。与 `s3_meta.dat` 同级别；**用户列表与 Secret 均仅存于此**，不写入 s3_meta、不发给客户端。 |
| **用途** | `s3_meta.dat`：桶、对象及桶/对象 next_id（**不含用户**）；`user.dat`：用户完整记录（含 secret），为用户的唯一数据源。 |

---

## 2. 通用规则

- **行式存储**：一条逻辑记录占一行，行内字段用 **制表符 `\t`** 分隔。
- **首字段为类型**：每行第一个字段为类型标识，用于区分记录种类：`N`、`B`、`O`、`U`。
- **字段禁止字符**：所有字段内容**禁止包含制表符 `\t` 和换行 `\n`**（简单实现下不做转义）。若后续需要支持，可约定转义规则（如 `\t`→`\\t`，`\n`→`\\n`），写入时转义、读出时反转义。
- **写回方式**：先完整写入 `s3_meta.dat.tmp`，成功关闭后再 `rename(tmp, s3_meta.dat)` 覆盖原文件。
- **并发**：多线程访问由 meta 层内部互斥锁保证，调用方仅通过 meta 接口读写。

---

## 3. 首行：next_id 行（类型 `N`，仅 s3_meta.dat）

**格式**：`N\t<bucket_next_id>\t<object_next_id>`

| 字段序号 | 含义 | 说明 |
|----------|------|------|
| 1 | 类型 | 固定为 `N` |
| 2 | bucket_next_id | 下一次创建桶时使用的 id（整数） |
| 3 | object_next_id | 下一次创建对象时使用的 id（整数） |

- **说明**：用户 next_id 存于 `user.dat` 首行，s3_meta.dat 不再包含用户相关字段。
- **新库**：文件不存在或无法打开时视为新库，桶/对象 next_id 均为 1。

---

## 4. 桶行（类型 `B`）

**格式**：`B\t<id>\t<name>\t<created_at>\t<owner_id>`

| 字段序号 | 含义 | 说明 |
|----------|------|------|
| 1 | 类型 | 固定为 `B` |
| 2 | id | 桶主键（整数） |
| 3 | name | 桶名，唯一 |
| 4 | created_at | 创建时间，建议格式 `YYYY-MM-DDTHH:MM:SSZ` |
| 5 | owner_id | 拥有者标识，本实现使用 Access Key |

---

## 5. 对象行（类型 `O`）

**格式**：`O\t<id>\t<bucket_id>\t<key>\t<size>\t<last_modified>\t<etag>\t<storage_path>\t<acl>`

| 字段序号 | 含义 | 说明 |
|----------|------|------|
| 1 | 类型 | 固定为 `O` |
| 2 | id | 对象主键（整数） |
| 3 | bucket_id | 所属桶 id（外键） |
| 4 | key | 对象键名 |
| 5 | size | 对象大小（字节，整数） |
| 6 | last_modified | 最后修改时间，建议 `YYYY-MM-DDTHH:MM:SSZ` |
| 7 | etag | 实体标签（可为空） |
| 8 | storage_path | 对象在文件系统中的存储路径 |
| 9 | acl | 访问控制，如 `private`、`public-read` |

同一 `bucket_id` + `key` 唯一确定一个对象；插入或覆盖时更新同键记录。

---

## 6. 用户数据文件 user.dat（与 s3_meta.dat 同级别，**用户唯一数据源**）

**路径**：`<data_root>/user.dat`。写回时先写 `<data_root>/user.dat.tmp`，成功后再 `rename` 覆盖。

**格式**：

- **首行**：`N\t<next_user_id>`，下一创建用户时使用的 id。
- **后续行**：`U\t<id>\t<username>\t<access_key>\t<secret_key>\t<created_at>`，字段禁止包含 `\t`、`\n`。

| 行类型 | 字段含义 |
|--------|----------|
| N | 类型、next_user_id |
| U | 类型、id、username、access_key、**secret_key**、created_at |

**用途**：用户列表与 Secret 均仅由此文件加载；服务端验签从内存缓存（由本文件加载）取 secret；创建用户时仅在此文件追加/写回，不写入 s3_meta.dat、不通过 API 返回 secret。

**兼容**：若文件存在但首行不是 `N`（旧格式每行 `access_key\tsecret_key`），则按旧格式加载 secret 并构造占位用户，下次 `save()` 写为新格式。

---

## 7. 文件示例

**s3_meta.dat**（无用户行；字段间为制表符，此处用空格示意）：

```
N	2	3
B	1	mybucket	2025-02-05T10:00:00Z	admin_access_key
O	1	1	readme.txt	100	2025-02-05T10:05:00Z		/data/s3/mybucket/readme.txt	private
```

**user.dat**（同目录；首行 N，后续 U 行含 id、username、access_key、secret_key、created_at）：

```
N	2
U	1	alice	AbCdEfGhIjKlMnOpQrSt	XyZ0123456789AbCdEfGhIjKlMnOpQrStUvWxYz	2025-02-05T12:00:00Z
```

---

## 8. 与代码的对应关系

- **加载**：`MetaStore::load(data_root)` 读取 `s3_meta.dat`（仅 N、B、O，无 U 行），再读取 `user.dat`（首行 N 得 next_user_id，后续 U 行得用户列表与 secret）填入 `users_` 与 `secret_by_access_key_`。
- **保存**：`MetaStore::save()` 写 `s3_meta.dat`（N 仅 2 个 next_id，无 U 行），再写 `user.dat`（首行 N，后续 U 行完整 6 字段）。
- **时间戳**：代码中生成的时间戳格式为 `%Y-%m-%dT%H:%M:%SZ`。

以上即当前元数据与用户密钥存储的格式规范。

